<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thanh to√°n | G·∫•u B√¥ng Online</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>

<body class="bg-gray-50 font-[Quicksand]">
  <!-- Header -->
  <div id="siteHeader"></div>

  <!-- Breadcrumb -->
  <div class="container mx-auto px-4 py-4 text-sm">
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/" class="inline-flex items-center text-gray-600 hover:text-pink-600">
            <i class="fas fa-home mr-2"></i> Trang ch·ªß
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
            <a href="cart.html" class="text-gray-600 hover:text-pink-600">Gi·ªè h√†ng</a>
          </div>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
            <span class="text-pink-600">Thanh to√°n</span>
          </div>
        </li>
      </ol>
    </nav>
  </div>

  <!-- Thanh to√°n -->
  <main class="container mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold text-pink-500 mb-8 text-center">Thanh to√°n ƒë∆°n h√†ng</h1>

    <div class="flex flex-col lg:flex-row gap-12">
      <!-- Th√¥ng tin ƒë∆°n h√†ng -->
      <div class="lg:w-2/3 bg-white p-4 lg:p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Chi ti·∫øt ƒë∆°n h√†ng</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-pink-100 text-pink-600">
              <tr>
                <th class="p-4">S·∫£n ph·∫©m</th>
                <th class="p-4 text-center">Gi√°</th>
                <th class="p-4 text-center">S·ªë l∆∞·ª£ng</th>
                <th class="p-4 text-center">Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody id="order-body"></tbody>
          </table>
        </div>
        <div class="mt-4 text-right">
          <p class="text-lg font-semibold text-gray-700">T·ªïng c·ªông: <span id="order-total"
              class="text-pink-500">0ƒë</span></p>
        </div>
      </div>

      <!-- Form th√¥ng tin kh√°ch h√†ng -->
      <div class="lg:w-1/3 bg-white p-4 lg:p-6 rounded-lg shadow-md lg:sticky lg:top-24">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Th√¥ng tin thanh to√°n</h2>
        <form id="checkout-form" class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-semibold text-gray-600">H·ªç v√† t√™n <span
                class="text-red-500">*</span></label>
            <div class="relative">
              <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              <input type="text" id="name" required aria-label="H·ªç v√† t√™n kh√°ch h√†ng"
                class="w-full mt-1 pl-10 p-2 border border-pink-200 rounded focus:outline-none focus:ring-2 focus:ring-pink-500" />
              <p id="name-error" class="text-red-500 text-xs mt-1 hidden" role="alert">Vui l√≤ng nh·∫≠p h·ªç v√† t√™n</p>
            </div>
          </div>
          <div>
            <label for="phone" class="block text-sm font-semibold text-gray-600">S·ªë ƒëi·ªán tho·∫°i <span
                class="text-red-500">*</span></label>
            <div class="relative">
              <i class="fas fa-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              <input type="tel" id="phone" required aria-label="S·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng"
                class="w-full mt-1 pl-10 p-2 border border-pink-200 rounded focus:outline-none focus:ring-2 focus:ring-pink-500" />
              <p id="phone-error" class="text-red-500 text-xs mt-1 hidden" role="alert">S·ªë ƒëi·ªán tho·∫°i ph·∫£i l√† 10 ch·ªØ s·ªë,
                b·∫Øt ƒë·∫ßu b·∫±ng 0</p>
            </div>
          </div>
          <div>
            <label for="address" class="block text-sm font-semibold text-gray-600">ƒê·ªãa ch·ªâ giao h√†ng <span
                class="text-red-500">*</span></label>
            <div class="relative">
              <i class="fas fa-map-marker-alt absolute left-3 top-4 text-gray-400"></i>
              <textarea id="address" required aria-label="ƒê·ªãa ch·ªâ giao h√†ng"
                class="w-full mt-1 pl-10 p-2 border border-pink-200 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"></textarea>
              <p id="address-error" class="text-red-500 text-xs mt-1 hidden" role="alert">Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-600">Ph∆∞∆°ng th·ª©c thanh to√°n <span
                class="text-red-500">*</span></label>
            <div class="space-y-2 mt-1">
              <label class="flex items-center">
                <input type="radio" name="payment" value="cod" required class="text-pink-500 mr-2" />
                <span>Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="payment" value="bank" class="text-pink-500 mr-2" />
                <span>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
              </label>
            </div>
          </div>
          <div>
            <label for="note" class="block text-sm font-semibold text-gray-600">Ghi ch√∫ ƒë∆°n h√†ng</label>
            <textarea id="note" aria-label="Ghi ch√∫ ƒë∆°n h√†ng"
              class="w-full mt-1 p-2 border border-pink-200 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"></textarea>
          </div>
          <div class="flex gap-4">
            <a href="cart.html"
              class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-medium text-center hover:bg-gray-300">Quay
              l·∫°i gi·ªè h√†ng</a>
            <button type="submit" id="submit-btn"
              class="w-full bg-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center transition-transform transform hover:-translate-y-1">
              <span id="submit-text">X√°c nh·∫≠n thanh to√°n</span>
              <i id="loading-icon" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
          </div>
        </form>
        <div class="mt-6 text-sm text-gray-600">
          <p><strong>Li√™n h·ªá:</strong></p>
          <p>Email: support@gaubongonline.vn</p>
          <p>Hotline: 0903 123 456</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal x√°c nh·∫≠n ƒë∆°n h√†ng -->
  <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full max-h-[80vh] overflow-y-auto">
      <h3 class="text-lg font-semibold text-gray-700 mb-4">X√°c nh·∫≠n ƒë∆°n h√†ng</h3>
      <div id="modal-order-body" class="space-y-2"></div>
      <p class="text-lg font-semibold text-gray-700 mt-4">T·ªïng c·ªông: <span id="modal-order-total"
          class="text-pink-500">0ƒë</span></p>
      <div class="mt-4">
        <p><strong>H·ªç v√† t√™n:</strong> <span id="modal-name"></span></p>
        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="modal-phone"></span></p>
        <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="modal-address"></span></p>
        <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> <span id="modal-payment"></span></p>
        <p><strong>Ghi ch√∫:</strong> <span id="modal-note"></span></p>
      </div>
      <div class="mt-6 flex justify-end gap-4">
        <button id="cancel-confirm"
          class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">H·ªßy</button>
        <button id="confirm-order" class="bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-600">X√°c
          nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Modal x√°c nh·∫≠n th√†nh c√¥ng -->
  <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full text-center">
      <i class="fas fa-check-circle text-4xl text-pink-500 mb-4"></i>
      <h3 class="text-lg font-semibold text-gray-700 mb-4">ƒê·∫∑t h√†ng th√†nh c√¥ng!</h3>
      <p class="text-gray-600 mb-6">üéâ C·∫£m ∆°n b·∫°n ƒë√£ mua s·∫Øm t·∫°i G·∫•u B√¥ng Online! ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.</p>
      <a href="shop.html" class="bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-600">Ti·∫øp t·ª•c mua s·∫Øm</a>
    </div>
  </div>

  <!-- Footer -->
  <div id="siteFooter"></div>

  <script type="module">
    import { loadPartials } from '../assets/js/main.js';
    loadPartials();

    const CART_STORAGE_KEY = 'shopping-cart';
    const orderBody = document.getElementById('order-body');
    const orderTotal = document.getElementById('order-total');
    const checkoutForm = document.getElementById('checkout-form');
    const confirmModal = document.getElementById('confirm-modal');
    const successModal = document.getElementById('success-modal');
    const modalOrderBody = document.getElementById('modal-order-body');
    const modalOrderTotal = document.getElementById('modal-order-total');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const loadingIcon = document.getElementById('loading-icon');

    function renderOrder() {
      // ∆Øu ti√™n l·∫•y d·ªØ li·ªáu t·ª´ sessionStorage (t·ª´ trang cart.html chuy·ªÉn qua)
      let cart;
      const checkoutItems = sessionStorage.getItem('checkout_items');
      const checkoutType = sessionStorage.getItem('checkout_type');

      if (checkoutItems) {
        // N·∫øu c√≥ d·ªØ li·ªáu t·ª´ sessionStorage, s·ª≠ d·ª•ng n√≥
        cart = JSON.parse(checkoutItems);

        // ƒê·∫£m b·∫£o gi√° s·∫£n ph·∫©m l√† s·ªë n·∫øu ƒëang ·ªü d·∫°ng chu·ªói
        cart = cart.map(item => {
          // X·ª≠ l√Ω gi√° l√† chu·ªói ho·∫∑c s·ªë
          let price = item.price;
          if (typeof price === 'string') {
            // Lo·∫°i b·ªè t·∫•t c·∫£ c√°c k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            price = parseFloat(price.replace(/[^\d]/g, ''));
          }

          return {
            ...item,
            price: price
          };
        });
      } else {
        // N·∫øu kh√¥ng c√≥, s·ª≠ d·ª•ng to√†n b·ªô gi·ªè h√†ng
        cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]');
      }

      orderBody.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        orderBody.innerHTML = `
          <tr>
            <td colspan="4" class="py-12">
              <div class="flex flex-col items-center bg-white border border-pink-200 rounded-lg p-8 shadow-md animate-fade-in">
                <i class="fas fa-shopping-cart text-5xl text-pink-500 mb-4"></i>
                <p class="text-2xl font-bold text-gray-700 mb-4">ƒê∆°n h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
                <a href="shop.html" class="bg-pink-500 text-white py-2 px-6 rounded-lg font-medium transition-transform transform hover:scale-105">Ti·∫øp t·ª•c mua s·∫Øm</a>
              </div>
            </td>
          </tr>`;
        orderTotal.textContent = '0ƒë';
        return;
      }

      cart.forEach(item => {
        const quantity = item.quantity || 1;
        const itemTotal = item.price * quantity;
        total += itemTotal;

        const row = document.createElement('tr');
        row.className = 'border-b';
        row.innerHTML = `
          <td class="p-4 flex items-center gap-4">
            <img src="${item.image}" class="w-20 h-20 object-cover rounded" loading="lazy">
            <div>
              <p class="font-semibold">${item.name}</p>
              ${item.size ? `<p class="text-sm text-gray-500">Size: ${item.size}</p>` : ''}
            </div>
          </td>
          <td class="text-center text-pink-500 font-semibold">${item.price.toLocaleString('vi-VN')}ƒë</td>
          <td class="text-center">${quantity}</td>
          <td class="text-center font-bold text-gray-700">${itemTotal.toLocaleString('vi-VN')}ƒë</td>
        `;
        orderBody.appendChild(row);
      });

      orderTotal.textContent = total.toLocaleString('vi-VN') + 'ƒë';
    }

    function renderModalOrder(cart) {
      modalOrderBody.innerHTML = '';
      let total = 0;

      cart.forEach(item => {
        const quantity = item.quantity || 1;
        // ƒê·∫£m b·∫£o gi√° l√† s·ªë
        const price = typeof item.price === 'string' ? parseFloat(item.price.replace(/[^\d]/g, '')) : item.price;
        const itemTotal = price * quantity;
        total += itemTotal;

        const div = document.createElement('div');
        div.className = 'flex justify-between';
        div.innerHTML = `
          <div>
            <p class="font-medium">${item.name}</p>
            ${item.size ? `<p class="text-sm text-gray-500">Size: ${item.size}</p>` : ''}
            <p class="text-sm text-gray-500">S·ªë l∆∞·ª£ng: ${quantity}</p>
          </div>
          <p class="font-semibold text-gray-700">${itemTotal.toLocaleString('vi-VN')}ƒë</p>
        `;
        modalOrderBody.appendChild(div);
      });

      modalOrderTotal.textContent = total.toLocaleString('vi-VN') + 'ƒë';
    }

    function validatePhone(phone) {
      return /^0\d{9}$/.test(phone);
    }

    function showError(fieldId, errorId, message) {
      const field = document.getElementById(fieldId);
      const error = document.getElementById(errorId);
      field.classList.add('border-red-500');
      error.textContent = message;
      error.classList.remove('hidden');
    }

    function clearErrors() {
      ['name', 'phone', 'address'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const error = document.getElementById(`${fieldId}-error`);
        field.classList.remove('border-red-500');
        error.classList.add('hidden');
      });
    }

    checkoutForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearErrors();

      // ∆Øu ti√™n l·∫•y d·ªØ li·ªáu t·ª´ sessionStorage
      let cart;
      const checkoutItems = sessionStorage.getItem('checkout_items');

      if (checkoutItems) {
        cart = JSON.parse(checkoutItems);
      } else {
        cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]');
      }

      if (!cart.length) {
        alert('ƒê∆°n h√†ng ƒëang tr·ªëng!');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const payment = document.querySelector('input[name="payment"]:checked')?.value;
      const note = document.getElementById('note').value.trim();

      let hasError = false;

      if (!name) {
        showError('name', 'name-error', 'Vui l√≤ng nh·∫≠p h·ªç v√† t√™n');
        hasError = true;
      }
      if (!phone || !validatePhone(phone)) {
        showError('phone', 'phone-error', 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i l√† 10 ch·ªØ s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0');
        hasError = true;
      }
      if (!address) {
        showError('address', 'address-error', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ');
        hasError = true;
      }
      if (!payment) {
        alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n');
        hasError = true;
      }

      if (hasError) return;

      submitText.textContent = 'ƒêang x·ª≠ l√Ω...';
      loadingIcon.classList.remove('hidden');
      submitBtn.disabled = true;

      setTimeout(() => {
        renderModalOrder(cart);
        document.getElementById('modal-name').textContent = name;
        document.getElementById('modal-phone').textContent = phone;
        document.getElementById('modal-address').textContent = address;
        document.getElementById('modal-payment').textContent = payment === 'cod' ? 'Thanh to√°n khi nh·∫≠n h√†ng' : 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng';
        document.getElementById('modal-note').textContent = note || 'Kh√¥ng c√≥';
        confirmModal.classList.remove('hidden');
        submitText.textContent = 'X√°c nh·∫≠n thanh to√°n';
        loadingIcon.classList.add('hidden');
        submitBtn.disabled = false;
      }, 500);
    });

    document.getElementById('cancel-confirm').addEventListener('click', () => {
      confirmModal.classList.add('hidden');
    });

    document.getElementById('confirm-order').addEventListener('click', () => {
      confirmModal.classList.add('hidden');

      // L·∫•y lo·∫°i thanh to√°n t·ª´ sessionStorage
      const checkoutType = sessionStorage.getItem('checkout_type');

      if (checkoutType === 'selected') {
        // N·∫øu ch·ªâ thanh to√°n m·ª•c ƒë√£ ch·ªçn, l·∫•y gi·ªè h√†ng hi·ªán t·∫°i v√† lo·∫°i b·ªè c√°c m·ª•c ƒë√£ ch·ªçn
        const selectedItems = JSON.parse(sessionStorage.getItem('checkout_items') || '[]');
        const currentCart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]');

        // L·ªçc gi·ªè h√†ng, lo·∫°i b·ªè c√°c m·ª•c ƒë√£ thanh to√°n
        const updatedCart = currentCart.filter(item => {
          // Ki·ªÉm tra xem item c√≥ trong selectedItems kh√¥ng
          return !selectedItems.some(selected =>
            selected.id === item.id && selected.size === item.size
          );
        });

        // C·∫≠p nh·∫≠t l·∫°i gi·ªè h√†ng
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(updatedCart));
      } else {
        // N·∫øu thanh to√°n t·∫•t c·∫£, x√≥a to√†n b·ªô gi·ªè h√†ng
        localStorage.removeItem(CART_STORAGE_KEY);
      }

      // X√≥a d·ªØ li·ªáu thanh to√°n kh·ªèi sessionStorage
      sessionStorage.removeItem('checkout_items');
      sessionStorage.removeItem('checkout_type');

      renderOrder();
      successModal.classList.remove('hidden');
    });

    document.getElementById('name').focus();

    document.addEventListener('DOMContentLoaded', () => {
      renderOrder();
    });
  </script>
</body>

</html>
